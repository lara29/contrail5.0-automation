# Copyright 2018, Juniper Networks Pvt Ltd.
# All rights reserved.
---
- name: Post install tasks
  hosts: contrail-ubuntu-vm
  gather_facts: false
  tasks:
  - shell: |
        kubectl get pods --all-namespaces|tee kube_status.txt
      args:
        executable: /bin/bash
      register: pod_status
  - debug:
      var: pod_status.stdout_lines

  - shell: |
      awk '{if(NR>1)print}' kube_status.txt|awk '{ print $4 }'| grep -v "Running"|wc -l
    args:
      executable: /bin/bash
    register: not_running
  - debug:
      var: not_running.stdout_lines

  - fail:
      msg: All pods need to be in running state
    when: not_running.stdout != "0" 
      
  - name: Install gcc
    yum:
      name: gcc
      state: latest
  - name: Install python-devel
    yum:
      name: python-devel
      state: latest
  - name: Install python-openstackclient
    yum:
      name: python-openstackclient
      state: latest
  - name: Install python-ironicclient
    yum:
      name: python-ironicclient
      state: latest
